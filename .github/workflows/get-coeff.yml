name: Get Coeff

on:
  schedule:
    - cron: "57 23 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  get-coeff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build coefficients snapshot
        run: node scripts/getCoeff.mjs
        env:
          UEFA_RANKINGS_YEAR: "2026"
          UEFA_COEFF_LIMIT: "100"
          UEFA_COMP_API_URL: ${{ secrets.UEFA_COMP_API_URL }}
          UEFA_API_KEY: ${{ secrets.UEFA_API_KEY }}
          OUTPUT_DIR: ${{ runner.temp }}/data
          UEFA_COEFF_OUTPUT_FILE: coefficients.json

      - name: Commit coefficients to data branch
        env:
          DATA_BRANCH: data
          DATA_DIR_PATH: data
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin "${DATA_BRANCH}" >/dev/null 2>&1; then
            git fetch origin "${DATA_BRANCH}"
            git switch --create "${DATA_BRANCH}" --track "origin/${DATA_BRANCH}" || git switch "${DATA_BRANCH}"
          else
            git switch --orphan "${DATA_BRANCH}"
            git rm -rf . || true
          fi

          mkdir -p "${DATA_DIR_PATH}"
          cp "${RUNNER_TEMP}/data/coefficients.json" "${DATA_DIR_PATH}/coefficients.json"

          git add "${DATA_DIR_PATH}/coefficients.json"
          if git diff --cached --quiet; then
            echo "No coefficient changes detected."
            exit 0
          fi

          git commit -m "chore(data): update uefa club coefficients top 100"
          git push origin "${DATA_BRANCH}"
