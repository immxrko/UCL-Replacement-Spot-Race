name: Sync Standings And Results

on:
  schedule:
    - cron: "59 23 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build standings snapshot
        run: node scripts/syncStandingsAndResults.mjs
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
          API_FOOTBALL_HOST: v3.football.api-sports.io
          API_BASE_URL: https://v3.football.api-sports.io
          FOCUS_TEAM_NAME: ${{ vars.FOCUS_TEAM_NAME || 'FK Crvena Zvezda' }}
          LEAGUE_ID: "286"
          SEASON: "2025"
          OUTPUT_FILE: ${{ runner.temp }}/standings.json

      - name: Commit snapshot to data branch
        env:
          DATA_BRANCH: data
          DATA_FILE_PATH: data/standings.json
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin "${DATA_BRANCH}" >/dev/null 2>&1; then
            git fetch origin "${DATA_BRANCH}"
            git switch --create "${DATA_BRANCH}" --track "origin/${DATA_BRANCH}" || git switch "${DATA_BRANCH}"
          else
            git switch --orphan "${DATA_BRANCH}"
            git rm -rf . || true
          fi

          mkdir -p "$(dirname "${DATA_FILE_PATH}")"
          cp "${RUNNER_TEMP}/standings.json" "${DATA_FILE_PATH}"

          git add "${DATA_FILE_PATH}"
          if git diff --cached --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git commit -m "chore(data): update standings snapshot"
          git push origin "${DATA_BRANCH}"
